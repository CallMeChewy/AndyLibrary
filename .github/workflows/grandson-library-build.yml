# File: grandson-library-build.yml
# Path: /home/herb/Desktop/AndyLibrary/.github/workflows/grandson-library-build.yml
# Standard: AIDEV-PascalCase-2.1
# Created: 2025-07-30
# Last Modified: 2025-07-30 05:10PM

name: Build Grandson's Library Windows EXE

on:
  push:
    paths:
      - 'Standalone/GrandsonLibrary.py'
      - 'Standalone/grandson-library-windows.spec'
      - '.github/workflows/grandson-library-build.yml'
  workflow_dispatch:
    inputs:
      build_reason:
        description: 'Reason for manual build'
        required: false
        default: 'Manual build for testing'

jobs:
  build-grandson-windows-exe:
    name: ðŸŽ“ Build Grandson's Educational Library
    runs-on: windows-latest
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ðŸ Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ðŸ“¦ Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller fastapi uvicorn requests aiofiles
        
    - name: ðŸ“š Setup database for grandson
      shell: powershell
      run: |
        # Check for database in various locations
        $dbPaths = @(
          "Data/Databases/MyLibrary.db",
          "Standalone/MyLibrary.db", 
          "Standalone/Data/MyLibrary.db"
        )
        
        $foundDb = $false
        foreach ($path in $dbPaths) {
          if (Test-Path $path) {
            $size = (Get-Item $path).Length / 1MB
            Write-Host "âœ… Database found at $path : $([math]::Round($size, 1))MB"
            
            # Copy to Standalone directory for easy access
            Copy-Item $path "Standalone/MyLibrary.db" -Force
            Write-Host "ðŸ“¥ Database copied to Standalone/MyLibrary.db"
            $foundDb = $true
            break
          }
        }
        
        if (-not $foundDb) {
          Write-Host "âš ï¸ No database found - grandson will get demo library"
        }
        
    - name: ðŸ”§ Build Windows EXE with PyInstaller  
      shell: cmd
      run: |
        pyinstaller --onefile --console --name "GrandsonLibrary" --add-data "Standalone/MyLibrary.db;." --add-data "WebPages;WebPages" --hidden-import "uvicorn.protocols.websockets.auto" --hidden-import "uvicorn.protocols.http.auto" --hidden-import "uvicorn.lifespan.on" --hidden-import "uvicorn.lifespan.off" --hidden-import "fastapi.routing" --hidden-import "fastapi.responses" --hidden-import "fastapi.staticfiles" --hidden-import "requests" --hidden-import "sqlite3" --hidden-import "threading" --hidden-import "webbrowser" Standalone/GrandsonLibrary.py
        
    - name: âœ… Verify build success
      shell: powershell
      run: |
        if (Test-Path "dist/GrandsonLibrary.exe") {
          $size = (Get-Item "dist/GrandsonLibrary.exe").Length / 1MB
          Write-Host "ðŸŽ‰ BUILD SUCCESS! ðŸŽ‰"
          Write-Host "ðŸ“„ File: GrandsonLibrary.exe"
          Write-Host "ðŸ“Š Size: $([math]::Round($size, 1))MB"
          Write-Host "ðŸ–¥ï¸ Platform: Windows x64"
          Write-Host "ðŸ“š Hard-coded for Granddaddy's Google Drive"
          Write-Host ""
          Write-Host "âœ… Ready for grandson deployment!"
        } else {
          Write-Host "âŒ Build failed - EXE not found"
          exit 1
        }
        
    - name: ðŸ“¤ Upload Windows EXE artifact
      uses: actions/upload-artifact@v4
      with:
        name: grandson-library-windows-exe
        path: dist/GrandsonLibrary.exe
        retention-days: 30
        
    - name: ðŸ“‹ Create deployment instructions
      run: |
        echo "# Grandson's Library - Windows EXE Ready!" > GRANDSON-DEPLOYMENT-READY.md
        echo "" >> GRANDSON-DEPLOYMENT-READY.md
        echo "Built Successfully - File: GrandsonLibrary.exe" >> GRANDSON-DEPLOYMENT-READY.md
        echo "Platform: Windows 64-bit" >> GRANDSON-DEPLOYMENT-READY.md
        echo "Database: 1,200+ books included" >> GRANDSON-DEPLOYMENT-READY.md
        echo "Setup: None required!" >> GRANDSON-DEPLOYMENT-READY.md
        
    - name: ðŸ“¤ Upload deployment instructions
      uses: actions/upload-artifact@v4  
      with:
        name: grandson-deployment-instructions
        path: GRANDSON-DEPLOYMENT-READY.md
        retention-days: 30