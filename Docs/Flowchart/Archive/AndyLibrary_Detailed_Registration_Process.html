
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AndyLibrary Detailed Registration Process Flowchart</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/panzoom@9.4.3/dist/panzoom.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 30px;
            margin: 0 auto;
            max-width: 98%;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 2.8em;
            margin: 0;
            font-weight: 700;
        }
        
        .header p {
            color: #7f8c8d;
            font-size: 1.3em;
            margin: 10px 0 0 0;
            font-weight: 600;
        }
        
        .info-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 5px solid #667eea;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }
        
        .info-section {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .info-section h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-weight: 700;
        }
        
        .info-section ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .info-section li {
            margin: 5px 0;
            font-size: 14px;
        }
        
        .diagram-container {
            text-align: center;
            background: #ffffff;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #ecf0f1;
            position: relative;
            overflow: hidden;
            height: 900px;
        }
        
        .zoom-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .zoom-btn {
            background: #667eea;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: all 0.2s ease;
        }
        
        .zoom-btn:hover {
            background: #5a67d8;
            transform: scale(1.1);
        }
        
        .pan-info {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1000;
        }
        
        .mermaid {
            background: #ffffff;
            border-radius: 8px;
            padding: 30px;
            font-family: 'Arial', sans-serif !important;
            transform-origin: center;
            transition: transform 0.3s ease;
        }
        
        .mermaid svg {
            font-family: 'Arial', sans-serif !important;
            font-weight: bold !important;
            background: #ffffff !important;
        }
        
        .mermaid .node text {
            font-family: 'Arial', sans-serif !important;
            font-size: 11px !important;
            font-weight: 800 !important;
            fill: #000000 !important;
            stroke: none !important;
        }
        
        .mermaid .edgeLabel text {
            font-family: 'Arial', sans-serif !important;
            font-size: 12px !important;
            font-weight: 900 !important;
            fill: #000000 !important;
            stroke: #ffffff !important;
            stroke-width: 2px !important;
            paint-order: stroke fill !important;
        }
        
        .mermaid .edgeLabel rect {
            fill: #ffffff !important;
            stroke: #333333 !important;
            stroke-width: 1px !important;
            opacity: 1.0 !important;
        }
        
        .controls {
            margin: 20px 0;
            text-align: center;
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 0 8px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            background: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        @media print {
            body {
                background: white;
            }
            .container {
                box-shadow: none;
                max-width: none;
            }
            .controls, .info-panel, .zoom-controls, .pan-info {
                display: none;
            }
            .diagram-container {
                height: auto;
                overflow: visible;
            }
            .mermaid {
                page-break-inside: avoid;
                transform: scale(0.7);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèõÔ∏è AndyLibrary Registration Process</h1>
            <p>Detailed User Flow ‚Ä¢ Data Requirements ‚Ä¢ System Responses</p>
        </div>
        
        <div class="info-panel">
            <h3>üìã Registration Process Overview</h3>
            <div class="info-grid">
                <div class="info-section">
                    <h4>üî¥ Required Fields</h4>
                    <ul>
                        <li><strong>Email Address:</strong> Valid format, unique</li>
                        <li><strong>Username:</strong> 3-20 characters, alphanumeric</li>
                        <li><strong>Password:</strong> 8+ characters, mixed case</li>
                        <li><strong>Confirm Password:</strong> Must match</li>
                        <li><strong>Mission Acknowledgment:</strong> Educational access</li>
                        <li><strong>Terms Agreement:</strong> Legal acceptance</li>
                    </ul>
                </div>
                <div class="info-section">
                    <h4>üü° Optional Fields</h4>
                    <ul>
                        <li><strong>Full Name:</strong> Display purposes</li>
                        <li><strong>Organization:</strong> Institution/company</li>
                        <li><strong>Country:</strong> Geographic preference</li>
                        <li><strong>Newsletter:</strong> Marketing communications</li>
                        <li><strong>Profile Picture:</strong> Avatar upload</li>
                    </ul>
                </div>
                <div class="info-section">
                    <h4>‚ö° Validation Process</h4>
                    <ul>
                        <li><strong>Client-Side:</strong> Real-time feedback</li>
                        <li><strong>Server-Side:</strong> Security validation</li>
                        <li><strong>Duplicate Check:</strong> Email/username</li>
                        <li><strong>Password Hash:</strong> bcrypt (cost: 12)</li>
                        <li><strong>Token Generation:</strong> UUID verification</li>
                    </ul>
                </div>
                <div class="info-section">
                    <h4>üìß Email Verification</h4>
                    <ul>
                        <li><strong>SMTP Server:</strong> smtp.gmail.com:465</li>
                        <li><strong>Token Expiration:</strong> 24 hours</li>
                        <li><strong>Retry Limit:</strong> 3 attempts/hour</li>
                        <li><strong>Delivery Tracking:</strong> Success/failure logs</li>
                        <li><strong>Manual Option:</strong> Support contact</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <button class="btn" onclick="window.print()">üñ®Ô∏è Print Diagram</button>
            <button class="btn" onclick="downloadDetailedSVG()">üíæ Download SVG</button>
            <button class="btn" onclick="downloadPNG()">üì∑ Download PNG</button>
            <button class="btn" onclick="resetZoom()">üîÑ Reset View</button>
            <button class="btn" onclick="toggleFullscreen()">üîç Fullscreen</button>
        </div>
        
        <div class="diagram-container" id="diagramContainer">
            <div class="zoom-controls">
                <button class="zoom-btn" onclick="zoomIn()" title="Zoom In">+</button>
                <button class="zoom-btn" onclick="zoomOut()" title="Zoom Out">‚àí</button>
                <button class="zoom-btn" onclick="resetZoom()" title="Reset">‚åÇ</button>
            </div>
            <div class="pan-info">
                üí° Drag to pan ‚Ä¢ Scroll to zoom ‚Ä¢ Follow the detailed registration sequence
            </div>
            <div class="mermaid" id="mermaidDiagram">

flowchart TD
    %% Detailed AndyLibrary Registration Process Flowchart
    %% Enhanced with comprehensive data requirements and sequences
    
    %% Start/End Nodes
    START([üöÄ START<br/><b>User Opens Browser</b>])
    END([‚úÖ END<br/><b>Book Access Complete</b>])
    
    %% Initial Landing and Authentication Check
    POWER_ON[‚ö° POWER ON<br/><b>Load Website</b><br/>‚Ä¢ Static assets load<br/>‚Ä¢ Service worker registers<br/>‚Ä¢ Check existing session]
    SCAN_ENV[üîç SCAN ENVIRONMENT<br/><b>Authentication Status Check</b><br/>‚Ä¢ Check session cookies<br/>‚Ä¢ Validate session tokens<br/>‚Ä¢ Load user preferences]
    GEN_MAP[üó∫Ô∏è GENERATE MAP<br/><b>Load User Interface</b><br/>‚Ä¢ Render auth forms<br/>‚Ä¢ Load CSS/JS assets<br/>‚Ä¢ Initialize form validation]
    
    %% Authentication Decision Point
    AUTH_CHECK{üîê USER<br/><b>AUTHENTICATED?</b><br/>Session token valid?}
    
    %% Registration Form Display and Data Collection
    SHOW_REG_FORM[üìù SHOW REGISTRATION FORM<br/><b>Display Input Fields</b><br/>‚Ä¢ Email input (required)<br/>‚Ä¢ Username input (required)<br/>‚Ä¢ Password input (required)<br/>‚Ä¢ Confirm password (required)<br/>‚Ä¢ Mission acknowledgment (required)<br/>‚Ä¢ Marketing opt-in (optional)<br/>‚Ä¢ Terms agreement (required)]
    
    %% User Data Entry Process
    USER_ENTERS_DATA[üë§ USER ENTERS DATA<br/><b>Form Field Input</b><br/>REQUIRED FIELDS:<br/>‚Ä¢ Email: user@example.com<br/>‚Ä¢ Username: johndoe (3-20 chars)<br/>‚Ä¢ Password: 8+ chars, mixed case<br/>‚Ä¢ Confirm Password: must match<br/>‚Ä¢ Mission: ‚òëÔ∏è Educational access<br/>‚Ä¢ Terms: ‚òëÔ∏è I agree<br/>OPTIONAL FIELDS:<br/>‚Ä¢ Full Name: John Doe<br/>‚Ä¢ Organization: University XYZ<br/>‚Ä¢ Country: Select from dropdown<br/>‚Ä¢ Newsletter: ‚òê Subscribe]
    
    %% Client-Side Validation
    CLIENT_VALIDATION[‚ö° CLIENT-SIDE VALIDATION<br/><b>Real-Time Field Validation</b><br/>‚Ä¢ Email format check (regex)<br/>‚Ä¢ Username availability hint<br/>‚Ä¢ Password strength meter<br/>‚Ä¢ Confirm password match<br/>‚Ä¢ Required field indicators<br/>‚Ä¢ Visual feedback (‚úÖ/‚ùå)]
    
    %% Form Submission
    USER_SUBMITS[üì§ USER SUBMITS FORM<br/><b>Form Submission Event</b><br/>‚Ä¢ Prevent default submit<br/>‚Ä¢ Gather form data<br/>‚Ä¢ Show loading spinner<br/>‚Ä¢ Disable submit button<br/>‚Ä¢ POST to /api/auth/register]
    
    %% Server-Side Validation Process
    SERVER_VALIDATION[üîç SERVER-SIDE VALIDATION<br/><b>Comprehensive Data Validation</b><br/>REQUIRED FIELD CHECKS:<br/>‚Ä¢ Email: present + valid format<br/>‚Ä¢ Username: 3-20 chars, alphanumeric<br/>‚Ä¢ Password: 8+ chars, complexity<br/>‚Ä¢ Mission: boolean true<br/>‚Ä¢ Terms: boolean true<br/>SECURITY CHECKS:<br/>‚Ä¢ SQL injection prevention<br/>‚Ä¢ XSS sanitization<br/>‚Ä¢ Rate limiting check<br/>‚Ä¢ CSRF token validation]
    
    %% Validation Results Decision
    VALIDATION_RESULT{‚úÖ VALIDATION<br/><b>PASSED?</b><br/>All required fields valid?}
    
    %% Validation Error Handling
    VALIDATION_ERROR[‚ùå VALIDATION ERROR<br/><b>Return Field-Specific Errors</b><br/>POSSIBLE ERRORS:<br/>‚Ä¢ Email: "Invalid format"<br/>‚Ä¢ Username: "Too short/long"<br/>‚Ä¢ Password: "Too weak"<br/>‚Ä¢ Mission: "Must acknowledge"<br/>‚Ä¢ Terms: "Must accept"<br/>HTTP Status: 422<br/>Response: Error details JSON]
    
    %% Database Duplicate Check
    DUPLICATE_CHECK[üîç DUPLICATE CHECK<br/><b>Database Query</b><br/>‚Ä¢ Check email in Users table<br/>‚Ä¢ Check username in Users table<br/>‚Ä¢ Case-insensitive comparison<br/>‚Ä¢ Query: SELECT * FROM Users<br/>  WHERE email=? OR username=?]
    
    %% Duplicate Check Results
    DUPLICATE_RESULT{üîç DUPLICATES<br/><b>FOUND?</b><br/>Email or username exists?}
    
    %% Duplicate Error Response
    DUPLICATE_ERROR[‚ùå DUPLICATE ERROR<br/><b>Conflict Response</b><br/>EMAIL EXISTS:<br/>‚Ä¢ Status: 409 Conflict<br/>‚Ä¢ Message: "Email already registered"<br/>‚Ä¢ Suggestion: "Try login instead"<br/>USERNAME EXISTS:<br/>‚Ä¢ Status: 409 Conflict<br/>‚Ä¢ Message: "Username taken"<br/>‚Ä¢ Suggestion: "Try: johndoe123"]
    
    %% User Account Creation Process
    CREATE_USER_ACCOUNT[‚úÖ CREATE USER ACCOUNT<br/><b>Database Insert Operation</b><br/>USER RECORD CREATION:<br/>‚Ä¢ Hash password with bcrypt (cost: 12)<br/>‚Ä¢ Generate verification token (UUID)<br/>‚Ä¢ Set EmailVerified = FALSE<br/>‚Ä¢ Set IsActive = FALSE<br/>‚Ä¢ Set SubscriptionTier = 'free'<br/>‚Ä¢ Set CreatedAt = NOW()<br/>‚Ä¢ Set AccessLevel = 'basic'<br/>‚Ä¢ Assign UserID (auto-increment)<br/>INSERT INTO Users VALUES (...)]
    
    %% Account Creation Success
    ACCOUNT_CREATED[üéâ ACCOUNT CREATED<br/><b>User Record Saved</b><br/>SYSTEM ACTIONS:<br/>‚Ä¢ User ID assigned: 30<br/>‚Ä¢ Password securely hashed<br/>‚Ä¢ Verification token generated<br/>‚Ä¢ Database transaction committed<br/>‚Ä¢ Audit log entry created<br/>‚Ä¢ User session prepared]
    
    %% Email Verification Process Start
    PREPARE_EMAIL[üìß PREPARE VERIFICATION EMAIL<br/><b>Email Template Generation</b><br/>EMAIL CONTENT:<br/>‚Ä¢ From: HimalayaProject1@gmail.com<br/>‚Ä¢ To: user@example.com<br/>‚Ä¢ Subject: "Welcome to AndyLibrary"<br/>‚Ä¢ Template: verification.html<br/>‚Ä¢ Verification URL with token<br/>‚Ä¢ Expiration: 24 hours<br/>‚Ä¢ Personalized greeting]
    
    %% SMTP Email Sending
    SEND_EMAIL_SMTP[üì§ SEND EMAIL VIA SMTP<br/><b>Email Delivery Process</b><br/>SMTP CONFIGURATION:<br/>‚Ä¢ Server: smtp.gmail.com:465<br/>‚Ä¢ Security: SSL/TLS enabled<br/>‚Ä¢ Auth: App password (svah...)<br/>‚Ä¢ Timeout: 30 seconds<br/>‚Ä¢ Retry: 3 attempts<br/>‚Ä¢ Delivery confirmation<br/>‚Ä¢ Error logging enabled]
    
    %% Email Send Result
    EMAIL_SEND_RESULT{üìß EMAIL<br/><b>SENT?</b><br/>SMTP success response?}
    
    %% Email Send Success
    EMAIL_SUCCESS[‚úÖ EMAIL SENT SUCCESSFULLY<br/><b>SMTP Delivery Confirmed</b><br/>SYSTEM RESPONSE:<br/>‚Ä¢ SMTP Status: 250 OK<br/>‚Ä¢ Message-ID recorded<br/>‚Ä¢ Delivery timestamp logged<br/>‚Ä¢ Email queue updated<br/>‚Ä¢ Success metrics incremented]
    
    %% Email Send Failure
    EMAIL_FAILURE[‚ùå EMAIL SEND FAILED<br/><b>SMTP Error Handling</b><br/>POSSIBLE ERRORS:<br/>‚Ä¢ SMTP server unavailable<br/>‚Ä¢ Authentication failure<br/>‚Ä¢ Rate limit exceeded<br/>‚Ä¢ Invalid recipient address<br/>‚Ä¢ Network timeout<br/>‚Ä¢ Quota exceeded<br/>Error logged for admin review]
    
    %% Registration Success Response
    REG_SUCCESS_RESPONSE[üéâ REGISTRATION SUCCESS<br/><b>Client Response</b><br/>HTTP Status: 201 Created<br/>JSON RESPONSE:<br/>{{<br/>  "success": true,<br/>  "message": "Registration successful",<br/>  "userId": 30,<br/>  "email": "user@example.com",<br/>  "emailSent": true,<br/>  "nextStep": "verify_email"<br/>}}<br/>‚Ä¢ Hide form, show success<br/>‚Ä¢ Display verification instructions]
    
    %% Registration Partial Success (No Email)
    REG_PARTIAL_SUCCESS[‚ö†Ô∏è REGISTRATION PARTIAL SUCCESS<br/><b>Account Created, Email Failed</b><br/>HTTP Status: 201 Created<br/>JSON RESPONSE:<br/>{{<br/>  "success": true,<br/>  "message": "Account created",<br/>  "userId": 30,<br/>  "emailSent": false,<br/>  "warning": "Email delivery failed",<br/>  "nextStep": "contact_support"<br/>}}<br/>‚Ä¢ Show manual verification option<br/>‚Ä¢ Provide support contact]
    
    %% User Email Verification Wait
    USER_WAITS[‚è≥ USER WAITS FOR EMAIL<br/><b>Email Verification Process</b><br/>USER ACTIONS NEEDED:<br/>‚Ä¢ Check email inbox<br/>‚Ä¢ Check spam/junk folder<br/>‚Ä¢ Look for sender verification<br/>‚Ä¢ Click verification link<br/>SYSTEM MONITORING:<br/>‚Ä¢ Token expiration timer<br/>‚Ä¢ Delivery status tracking<br/>‚Ä¢ User session maintenance]
    
    %% Email Receipt Check
    EMAIL_RECEIVED{üìß EMAIL<br/><b>RECEIVED?</b><br/>User found verification email?}
    
    %% User Clicks Verification Link
    USER_CLICKS_VERIFY[üëÜ USER CLICKS VERIFICATION<br/><b>Email Link Action</b><br/>VERIFICATION LINK:<br/>‚Ä¢ URL: /api/auth/verify-email<br/>‚Ä¢ Parameter: ?token=abc123...<br/>‚Ä¢ Method: GET request<br/>‚Ä¢ Browser redirect<br/>‚Ä¢ Token validation required<br/>‚Ä¢ Session state check]
    
    %% Token Validation Process
    TOKEN_VALIDATION[üé´ TOKEN VALIDATION<br/><b>Server-Side Verification</b><br/>VALIDATION CHECKS:<br/>‚Ä¢ Token exists in database<br/>‚Ä¢ Token not expired (24h limit)<br/>‚Ä¢ Token matches user record<br/>‚Ä¢ User not already verified<br/>‚Ä¢ Token not previously used<br/>QUERY: SELECT * FROM Users<br/>WHERE verification_token=?<br/>AND EmailVerified=FALSE]
    
    %% Token Validation Result
    TOKEN_VALID_RESULT{üé´ TOKEN<br/><b>VALID?</b><br/>Verification token accepted?}
    
    %% Account Activation Process
    ACTIVATE_ACCOUNT[‚úÖ ACTIVATE ACCOUNT<br/><b>Account Verification Complete</b><br/>DATABASE UPDATES:<br/>‚Ä¢ EmailVerified = TRUE<br/>‚Ä¢ IsActive = TRUE<br/>‚Ä¢ VerifiedAt = NOW()<br/>‚Ä¢ verification_token = NULL<br/>‚Ä¢ AccessLevel = 'verified'<br/>UPDATE Users SET ... WHERE id=30<br/>‚Ä¢ Commit transaction<br/>‚Ä¢ Audit log entry]
    
    %% Verification Success Response
    VERIFY_SUCCESS[üéâ VERIFICATION SUCCESS<br/><b>Account Fully Activated</b><br/>HTTP Status: 200 OK<br/>RESPONSE:<br/>{{<br/>  "success": true,<br/>  "message": "Email verified",<br/>  "accountActive": true,<br/>  "nextStep": "login"<br/>}}<br/>‚Ä¢ Redirect to login page<br/>‚Ä¢ Show success message<br/>‚Ä¢ Clear verification state]
    
    %% Verification Error Handling
    VERIFY_ERROR[‚ùå VERIFICATION ERROR<br/><b>Token Validation Failed</b><br/>POSSIBLE ERRORS:<br/>‚Ä¢ Token expired (24h limit)<br/>‚Ä¢ Token not found<br/>‚Ä¢ Token already used<br/>‚Ä¢ Account already verified<br/>‚Ä¢ Malformed token<br/>HTTP Status: 400/404/410<br/>‚Ä¢ Show error page<br/>‚Ä¢ Offer resend option]
    
    %% Resend Verification Option
    RESEND_OPTION[üîÑ RESEND VERIFICATION<br/><b>New Verification Email</b><br/>USER ACTION:<br/>‚Ä¢ Click "Resend Email" button<br/>‚Ä¢ POST /api/auth/resend-verification<br/>SYSTEM RESPONSE:<br/>‚Ä¢ Generate new token<br/>‚Ä¢ Send new email<br/>‚Ä¢ Update database<br/>‚Ä¢ Rate limit check (max 3/hour)]
    
    %% Continue to Login Process
    CONTINUE_LOGIN[‚ñ∂Ô∏è CONTINUE TO LOGIN<br/><b>Ready for Authentication</b><br/>ACCOUNT STATUS:<br/>‚Ä¢ Email verified ‚úÖ<br/>‚Ä¢ Account active ‚úÖ<br/>‚Ä¢ Ready for login ‚úÖ<br/>‚Ä¢ Access level: verified<br/>‚Ä¢ User can now authenticate<br/>‚Ä¢ Full system access enabled]
    
    %% LOGIN PROCESS (Simplified for space)
    LOGIN_PROCESS[üîë LOGIN PROCESS<br/><b>User Authentication</b><br/>‚Ä¢ Email/password form<br/>‚Ä¢ Credential validation<br/>‚Ä¢ Session creation<br/>‚Ä¢ Access granted]
    
    %% Continue to Main System
    MAIN_SYSTEM[üìö MAIN SYSTEM ACCESS<br/><b>Full AndyLibrary Features</b><br/>‚Ä¢ Book search and browse<br/>‚Ä¢ Google Drive integration<br/>‚Ä¢ User profile management<br/>‚Ä¢ Reading history<br/>‚Ä¢ Preferences settings]
    
    %% MAIN FLOW CONNECTIONS
    START --> POWER_ON
    POWER_ON --> SCAN_ENV
    SCAN_ENV --> GEN_MAP
    GEN_MAP --> AUTH_CHECK
    
    %% Authentication Decision
    AUTH_CHECK -->|<b>‚ùå NO</b>| SHOW_REG_FORM
    AUTH_CHECK -->|<b>‚úÖ YES</b>| MAIN_SYSTEM
    
    %% Registration Form Flow
    SHOW_REG_FORM --> USER_ENTERS_DATA
    USER_ENTERS_DATA --> CLIENT_VALIDATION
    CLIENT_VALIDATION --> USER_SUBMITS
    USER_SUBMITS --> SERVER_VALIDATION
    
    %% Server Validation Flow
    SERVER_VALIDATION --> VALIDATION_RESULT
    VALIDATION_RESULT -->|<b>‚ùå FAILED</b>| VALIDATION_ERROR
    VALIDATION_RESULT -->|<b>‚úÖ PASSED</b>| DUPLICATE_CHECK
    
    %% Error Handling
    VALIDATION_ERROR -->|<b>üîÑ FIX & RETRY</b>| USER_ENTERS_DATA
    
    %% Duplicate Check Flow
    DUPLICATE_CHECK --> DUPLICATE_RESULT
    DUPLICATE_RESULT -->|<b>‚úÖ UNIQUE</b>| CREATE_USER_ACCOUNT
    DUPLICATE_RESULT -->|<b>‚ùå DUPLICATE</b>| DUPLICATE_ERROR
    DUPLICATE_ERROR -->|<b>üîÑ FIX & RETRY</b>| USER_ENTERS_DATA
    
    %% Account Creation Flow
    CREATE_USER_ACCOUNT --> ACCOUNT_CREATED
    ACCOUNT_CREATED --> PREPARE_EMAIL
    PREPARE_EMAIL --> SEND_EMAIL_SMTP
    
    %% Email Send Results
    SEND_EMAIL_SMTP --> EMAIL_SEND_RESULT
    EMAIL_SEND_RESULT -->|<b>‚úÖ SUCCESS</b>| EMAIL_SUCCESS
    EMAIL_SEND_RESULT -->|<b>‚ùå FAILED</b>| EMAIL_FAILURE
    
    %% Registration Response
    EMAIL_SUCCESS --> REG_SUCCESS_RESPONSE
    EMAIL_FAILURE --> REG_PARTIAL_SUCCESS
    
    %% User Verification Wait
    REG_SUCCESS_RESPONSE --> USER_WAITS
    REG_PARTIAL_SUCCESS --> USER_WAITS
    
    %% Email Verification Flow
    USER_WAITS --> EMAIL_RECEIVED
    EMAIL_RECEIVED -->|<b>‚úÖ YES</b>| USER_CLICKS_VERIFY
    EMAIL_RECEIVED -->|<b>‚ùå NO</b>| RESEND_OPTION
    
    %% Token Validation Flow
    USER_CLICKS_VERIFY --> TOKEN_VALIDATION
    TOKEN_VALIDATION --> TOKEN_VALID_RESULT
    TOKEN_VALID_RESULT -->|<b>‚úÖ VALID</b>| ACTIVATE_ACCOUNT
    TOKEN_VALID_RESULT -->|<b>‚ùå INVALID</b>| VERIFY_ERROR
    
    %% Account Activation
    ACTIVATE_ACCOUNT --> VERIFY_SUCCESS
    VERIFY_SUCCESS --> CONTINUE_LOGIN
    
    %% Error Recovery
    VERIFY_ERROR --> RESEND_OPTION
    RESEND_OPTION --> PREPARE_EMAIL
    
    %% Final Flow
    CONTINUE_LOGIN --> LOGIN_PROCESS
    LOGIN_PROCESS --> MAIN_SYSTEM
    MAIN_SYSTEM --> END
    
    %% DETAILED PROFESSIONAL STYLING
    classDef startEndClass fill:#e1f5fe,stroke:#01579b,stroke-width:4px,color:#000000,font-size:14px,font-weight:900
    classDef processClass fill:#f3e5f5,stroke:#4a148c,stroke-width:3px,color:#000000,font-size:12px,font-weight:800
    classDef decisionClass fill:#fff3e0,stroke:#e65100,stroke-width:3px,color:#000000,font-size:13px,font-weight:800
    classDef userActionClass fill:#e8f5e8,stroke:#2e7d32,stroke-width:3px,color:#000000,font-size:12px,font-weight:800
    classDef errorClass fill:#ffebee,stroke:#c62828,stroke-width:3px,color:#000000,font-size:12px,font-weight:800
    classDef successClass fill:#f1f8e9,stroke:#33691e,stroke-width:3px,color:#000000,font-size:12px,font-weight:800
    classDef dataClass fill:#fce4ec,stroke:#880e4f,stroke-width:3px,color:#000000,font-size:12px,font-weight:800
    
    %% APPLY DETAILED STYLES
    class START,END startEndClass
    class POWER_ON,SCAN_ENV,GEN_MAP,SERVER_VALIDATION,DUPLICATE_CHECK,CREATE_USER_ACCOUNT,PREPARE_EMAIL,SEND_EMAIL_SMTP,TOKEN_VALIDATION,ACTIVATE_ACCOUNT,LOGIN_PROCESS,MAIN_SYSTEM processClass
    class AUTH_CHECK,VALIDATION_RESULT,DUPLICATE_RESULT,EMAIL_SEND_RESULT,EMAIL_RECEIVED,TOKEN_VALID_RESULT decisionClass
    class SHOW_REG_FORM,USER_ENTERS_DATA,CLIENT_VALIDATION,USER_SUBMITS,USER_WAITS,USER_CLICKS_VERIFY userActionClass
    class VALIDATION_ERROR,DUPLICATE_ERROR,EMAIL_FAILURE,VERIFY_ERROR errorClass
    class ACCOUNT_CREATED,EMAIL_SUCCESS,REG_SUCCESS_RESPONSE,VERIFY_SUCCESS,CONTINUE_LOGIN successClass
    class REG_PARTIAL_SUCCESS,RESEND_OPTION dataClass

            </div>
        </div>
    </div>

    <script>
        let panzoom;
        
        // Initialize Mermaid with detailed settings
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: false,
                htmlLabels: true,
                curve: 'basis',
                padding: 15
            },
            themeVariables: {
                primaryColor: '#f3e5f5',
                primaryTextColor: '#000000',
                primaryBorderColor: '#4a148c',
                lineColor: '#333333',
                sectionBkgColor: '#ffffff',
                altSectionBkgColor: '#f8f9fa',
                gridColor: '#e1e1e1',
                secondaryColor: '#fff3e0',
                tertiaryColor: '#e1f5fe',
                fontSize: '11px',
                fontFamily: 'Arial, sans-serif',
                background: '#ffffff'
            }
        });
        
        // Initialize pan/zoom after Mermaid renders
        setTimeout(() => {
            const element = document.getElementById('mermaidDiagram');
            panzoom = Panzoom(element, {
                maxScale: 4,
                minScale: 0.2,
                startScale: 0.6,
                cursor: 'grab'
            });
            
            element.parentElement.addEventListener('wheel', panzoom.zoomWithWheel);
        }, 1500);
        
        function zoomIn() {
            if (panzoom) panzoom.zoomIn();
        }
        
        function zoomOut() {
            if (panzoom) panzoom.zoomOut();
        }
        
        function resetZoom() {
            if (panzoom) panzoom.reset();
        }
        
        function downloadDetailedSVG() {
            const svg = document.querySelector('.mermaid svg');
            if (svg) {
                const clonedSvg = svg.cloneNode(true);
                clonedSvg.style.background = '#ffffff';
                clonedSvg.setAttribute('style', 'background: #ffffff');
                
                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('width', '100%');
                rect.setAttribute('height', '100%');
                rect.setAttribute('fill', '#ffffff');
                clonedSvg.insertBefore(rect, clonedSvg.firstChild);
                
                const textElements = clonedSvg.querySelectorAll('text');
                textElements.forEach(text => {
                    text.style.fontFamily = 'Arial, sans-serif';
                    text.style.fontWeight = 'bold';
                    text.style.fontSize = '11px';
                    text.style.fill = '#000000';
                    text.setAttribute('font-family', 'Arial, sans-serif');
                    text.setAttribute('font-weight', 'bold');
                    text.setAttribute('fill', '#000000');
                });
                
                const serializer = new XMLSerializer();
                const source = '<?xml version="1.0" encoding="UTF-8"?>\n' + serializer.serializeToString(clonedSvg);
                const blob = new Blob([source], {type: 'image/svg+xml;charset=utf-8'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'AndyLibrary_Detailed_Registration_Process.svg';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        }
        
        function downloadPNG() {
            const svg = document.querySelector('.mermaid svg');
            if (svg) {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                const svgClone = svg.cloneNode(true);
                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('width', '100%');
                rect.setAttribute('height', '100%');
                rect.setAttribute('fill', '#ffffff');
                svgClone.insertBefore(rect, svgClone.firstChild);
                
                const data = new XMLSerializer().serializeToString(svgClone);
                const blob = new Blob([data], {type: 'image/svg+xml;charset=utf-8'});
                const url = URL.createObjectURL(blob);
                const img = new Image();
                
                img.onload = function() {
                    canvas.width = img.width * 2;
                    canvas.height = img.height * 2;
                    ctx.scale(2, 2);
                    ctx.fillStyle = '#ffffff';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);
                    
                    canvas.toBlob(function(pngBlob) {
                        const pngUrl = URL.createObjectURL(pngBlob);
                        const a = document.createElement('a');
                        a.href = pngUrl;
                        a.download = 'AndyLibrary_Detailed_Registration_Process.png';
                        a.click();
                        URL.revokeObjectURL(pngUrl);
                    }, 'image/png');
                    
                    URL.revokeObjectURL(url);
                };
                
                img.src = url;
            }
        }
        
        function toggleFullscreen() {
            const container = document.getElementById('diagramContainer');
            if (!document.fullscreenElement) {
                container.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }
    </script>
</body>
</html>
